<?php
$class      = "notice-error";
$message    = "";
if(sanitize_text_field(isset($_POST["btn_action"])))
{
    $ids = json_decode(base64_decode(sanitize_text_field($_POST["ids"])), true);
    if(sanitize_text_field($_POST["action"])=="")
    {
        $message = "Please select bulk action you want to perform!";
    }
    else if(!$ids)
    {
        $message = "Please select one or more id to perform this action!";
    }
    else
    {
        $ids = sanitize_text_field($ids);
        switch(sanitize_text_field($_POST["action"]))
        {
            //block_ips unblock_ips add_alert remove_alert
            case "block_ips":

                $ips = get_option('wpasl-sus-ips', false);
                $bipsCount = 0;
                if($ips)
                {
                    $ips_e = explode("\r\n", $ips);
                    for($i=0; $i<count($ids); $i++)
                    {
                        if(in_array($ids[$i]["ip"], $ips_e))
                        {
                            continue;
                        }
                        $ips .= $ids[$i]["ip"]."\r\n";
                        $bipsCount++;
                    }
                }
                else
                {
                    $uipArr = [];
                    $ips = "";
                    for($i=0; $i<count($ids); $i++)
                    {
                        if(in_array($ids[$i]["ip"], $uipArr))
                        {
                            continue;
                        }
                        $uipArr [] = $ids[$i]["ip"];
                        $ips .= $ids[$i]["ip"]."\r\n";
                        $bipsCount++;
                    }
                }
                update_option('wpasl-sus-ips', $ips);

                if($bipsCount>0)
                {
                    $class   = "notice-info";
                    $message = $bipsCount." IPs has been blocked successfully!";
                }
                else
                {
                    $class   = "notice-info";
                    $message = "Seems like all the selected IPs are blocked already!";
                }

            break;

            case "add_alert":


                $urls = get_option('wpasl-sus-urls', false);
                $urlsCount = 0;
                if($urls)
                {
                    $urls_e = explode("\r\n", $urls);
                    for($i=0; $i<count($ids); $i++)
                    {
                        if(in_array($ids[$i]["url"], $urls_e))
                        {
                            continue;
                        }
                        $urls .= $ids[$i]["url"]."\r\n";
                        $urlsCount++;
                    }
                }
                else
                {
                    $uipArr = [];
                    $urls = "";
                    for($i=0; $i<count($ids); $i++)
                    {
                        if(in_array($ids[$i]["url"], $uipArr))
                        {
                            continue;
                        }
                        $uipArr [] = $ids[$i]["url"];
                        $urls .= $ids[$i]["url"]."\r\n";
                        $urlsCount++;
                    }
                }
                update_option('wpasl-sus-urls', $urls);

                if($urlsCount>0)
                {
                    $class   = "notice-info";
                    $message = $urlsCount." URLs has been added to alert list successfully!";
                }
                else
                {
                    $class   = "notice-info";
                    $message = "Seems like all the selected URLs are already in list!";
                }

            break;
        }
    }
}
?>

<div class="wrap">
    <?php
    if(sanitize_text_field(isset($_POST["btn_action"])))
    {
    ?>
        <div class="notice <?php echo esc_attr($class); ?> is-dismissible">
            <p><?php echo esc_attr($message)?></p>
        </div>
    <?php
    }

    $data = WPASL_DBSchema::getLog();
    ?>
    <h1 class="wp-heading-inline">WPASL Logs</h1>
    <hr class="wp-header-end">

    <form method="get" action="admin.php">
        <p class="search-box">
            <input type="hidden" name="page" value="wpasl-logs" />
            <input type="text"" name="q" value="<?php echo sanitize_text_field(isset($_GET["q"])) && sanitize_text_field($_GET["q"])!="" ? sanitize_text_field($_GET["q"]) : ""?>" placeholder="URL Search Keyword...">
            <input type="radio" name="qtype" value="wildcard" <?php echo (sanitize_text_field(isset($_GET["qtype"]))) && (sanitize_text_field($_GET["qtype"])=="wildcard" || !isset($_GET["qtype"])) ? "checked" : ""?> /> Wild Card %text%
            <input type="radio" name="qtype" value="regex" <?php echo (sanitize_text_field(isset($_GET["qtype"])) && sanitize_text_field($_GET["qtype"])=="regex") ? "checked" : ""?> /> Regex &nbsp;&nbsp;
            <input type="submit" name="btnsearch" class="button" value="Search">&nbsp;&nbsp;
            <a href="admin.php?page=wpasl-logs">Show All</a>
        </p>
    </form>

    <div class="tablenav top">
        <div class="alignleft actions bulkactions">
            <form method="post" action="">
                <select name="action" id="bulk-action-selector-top">
                    <option value="">Actions</option>
                    <option value="block_ips">Block Selected IPs</option>
                    <option value="add_alert">Add URLs to Alert</option>
                </select>
                <input type="hidden" name="ids" value="" />
                <input name="btn_action" type="submit" class="button action" value="Apply">
            </form>
        </div>

        <h2 class="screen-reader-text">Pages list navigation</h2>
        <div class="tablenav-pages">
            <?php echo WPASL_DBSchema::getLogPagination();?>
        </div>
        <br class="clear">
    </div>

    <table class="widefat fixed" cellspacing="0">
        <thead>
        <tr>
            <td id="cb" class="manage-column column-cb check-column">
                <label class="screen-reader-text" for="cb-select-all-1">Select All</label>
                <input id="cb-select-all-wpasl-1" type="checkbox">
            </td>
            <th scope="col" id="title" class="manage-column column-title column-primary">
                <a href="javascript:void(0)">
                    <span>IP</span>
                </a>
            </th>
            <th id="type" class="manage-column column-columnname" scope="col">
                Type
            </th>
            <th id="type" class="manage-column column-columnname" scope="col">
                User/Visitor
            </th>
            <th id="type" class="manage-column column-columnname" scope="col">
                Platform/Browser
            </th>
            <th id="type" class="manage-column column-columnname" scope="col">
                Url
            </th>
            <th id="type" class="manage-column column-columnname" scope="col">
                Date Time
            </th>

        </tr>
        </thead>

        <tfoot>
        <tr>
            <td class="manage-column column-cb check-column">
                <label class="screen-reader-text" for="cb-select-all-1">Select All</label>
                <input id="cb-select-all-wpasl-2" type="checkbox">
            </td>
            <th scope="col" class="manage-column">
                <a href="javascript:void(0)">
                    <span>IP</span>
                </a>
            </th>
            <th class="manage-column column-columnname" scope="col">
                Type
            </th>
            <th class="manage-column column-columnname" scope="col">
                User/Visitor
            </th>
            <th class="manage-column column-columnname" scope="col">
                Platform/Browser
            </th>
            <th class="manage-column column-columnname  column-title column-primary" scope="col">
                Url
            </th>
            <th class="manage-column column-columnname" scope="col">
                Date Time
            </th>
        </tr>
        </tfoot>
        <tbody>
            <?php
            $count = count($data);
            if($count>0)
            {
                for($i=0; $i<$count; $i++)
                {
                    $class = "alternate";
                    if($i%2==1)
                    {
                        $class = "";
                    }

                    echo
                    '
                        <tr class="'.$class.'">
                            <th  class="manage-column column-cb check-column">
                                <input type="checkbox" name="bulkCheck[]" value="'.$data[$i]['sno'].'">
                            </th>
                            <td scope="col" class="title column-title has-row-actions">
                                <input type="hidden" name="bulkIp-'.$data[$i]['sno'].'" value="'.$data[$i]['ip'].'">
                                <a class="row-title" href="javascript:void(0)">
                                    <span>'.$data[$i]['ip'].'</span>
                                </a>
                            </td>
                            <td class="manage-column column-columnname" scope="col">
                                '.($data[$i]['type']=="admin" ? '<span style="background-color: #FF1744; padding: 5px; color: #fff;">Back-End</span>' : '<span style="background-color: #FFEB3B;  padding: 5px; color: #000; ">Front-End</span>').'
                            </td>
                            <td class="manage-column column-columnname" scope="col">
                                '.($data[$i]['user_id']==0 ? "Visitor" : ucfirst($data[$i]['user_login'])).'
                            </td>
                            <td class="manage-column column-columnname" scope="col">
                                '.$data[$i]['platform'].'
                            </td>
                            <td class="manage-column column-columnname column-primary page-title" scope="col">
                                <input type="hidden" name="bulkUrl-'.$data[$i]['sno'].'" value="'.$data[$i]['url'].'">
                                '.$data[$i]['url'].'
                            </td>
                            <td class="manage-column column-columnname" scope="col">
                                '.get_date_from_gmt( $data[$i]['datetime']).'
                            </td>
                        </tr>
                    ';
                }
            }
            else
            {
                echo
                '
                    <tr class="alternate">
                        <td class="check-column" scope="row" colspan="7" style="text-align: center">No records to display!</td>
                    </tr>
                ';
            }
            ?>
            <!--<tr class="alternate">
                <th class="check-column" scope="row"></th>
                <td class="column-columnname"></td>
                <td class="column-columnname"></td>
            </tr>
            <tr>
                <th class="check-column" scope="row"></th>
                <td class="column-columnname"></td>
                <td class="column-columnname"></td>
            </tr>-->
        </tbody>
    </table>

</div>
